# üîê Gu√≠a de Manejo de Sesiones y Tokens - Empathica

## üìã Tabla de Contenidos

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Componentes Principales](#componentes-principales)
4. [Flujo de Autenticaci√≥n](#flujo-de-autenticaci√≥n)
5. [Protecciones de Seguridad](#protecciones-de-seguridad)
6. [Manejo de Errores](#manejo-de-errores)
7. [Configuraci√≥n](#configuraci√≥n)
8. [Troubleshooting](#troubleshooting)

---

## üéØ Descripci√≥n General

El sistema de manejo de sesiones y tokens de Empathica est√° dise√±ado para proporcionar una experiencia de usuario segura y fluida, evitando problemas comunes como sesiones mezcladas, tokens obsoletos y accesos no autorizados.

### üéØ Objetivos del Sistema

- ‚úÖ **Prevenir sesiones mezcladas** entre diferentes usuarios
- ‚úÖ **Manejar autom√°ticamente la expiraci√≥n de tokens**
- ‚úÖ **Limpiar sesiones en escenarios de cierre/error**
- ‚úÖ **Proporcionar timeout por inactividad**
- ‚úÖ **Alertar al usuario antes de la expiraci√≥n**
- ‚úÖ **Mantener la seguridad sin comprometer la UX**

---

## üèóÔ∏è Arquitectura del Sistema

### üìÅ Estructura de Archivos

```
src/
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.jsx          # Contexto principal de autenticaci√≥n
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ api.js                   # Servicios API con interceptores
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useSessionTimeout.js     # Hook para timeout de sesi√≥n
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ SessionTimeoutAlert.jsx  # Alerta de expiraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ PsychologistDashboard.jsx
‚îÇ   ‚îú‚îÄ‚îÄ ClientDashboard.jsx
‚îÇ   ‚îî‚îÄ‚îÄ BusinessDashboard.jsx
```

### üîÑ Flujo de Datos

```
Usuario ‚Üí Login ‚Üí Token JWT ‚Üí localStorage ‚Üí Interceptores ‚Üí API Calls
   ‚Üì
Contexto ‚Üí Estado Global ‚Üí Componentes ‚Üí Timeout/Alertas
```

---

## üß© Componentes Principales

### 1. **AuthContext.jsx** - Contexto de Autenticaci√≥n

**Responsabilidades:**
- Gesti√≥n del estado global de autenticaci√≥n
- Mapeo de roles del backend a tipos de usuario
- Limpieza autom√°tica de sesiones
- Event listeners para cierre de ventana

**Funciones Principales:**

```javascript
// Login con limpieza autom√°tica de sesi√≥n anterior
const login = async (credentials) => {
  // 1. Limpiar sesi√≥n anterior
  clearSession();
  
  // 2. Hacer login
  const response = await authService.login(credentials);
  
  // 3. Obtener detalles del usuario
  const userDetails = await userService.getUserDetails();
  
  // 4. Mapear roles y guardar
  const userWithType = mapUserRolesToType(userDetails);
  setUser(userWithType);
};

// Limpieza completa de sesi√≥n
const clearSession = () => {
  localStorage.removeItem('empathica_token');
  localStorage.removeItem('empathica_user');
  setUser(null);
};
```

### 2. **api.js** - Servicios API con Interceptores

**Interceptores Implementados:**

#### Request Interceptor
```javascript
apiClient.interceptors.request.use((config) => {
  // Verificar expiraci√≥n del token antes de cada request
  if (isTokenExpired()) {
    clearSession();
    window.location.href = '/login';
    return Promise.reject(new Error('Token expirado'));
  }
  
  // Agregar token a headers
  const token = localStorage.getItem('empathica_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

#### Response Interceptor
```javascript
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token expirado o inv√°lido
      clearSession();
      window.location.href = '/login';
    } else if (error.response?.status === 403) {
      // Acceso denegado
      clearSession();
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

### 3. **useSessionTimeout.js** - Hook de Timeout

**Funcionalidades:**
- Timeout por inactividad (60 minutos por defecto)
- Reset autom√°tico con actividad del usuario
- Event listeners para mouse, teclado, scroll, touch

```javascript
export const useSessionTimeout = (timeoutMinutes = 60) => {
  const { clearSession } = useAuth();
  
  const resetTimeout = () => {
    // Resetear timeout con actividad del usuario
    clearTimeout(timeoutRef.current);
    timeoutRef.current = setTimeout(() => {
      clearSession();
      window.location.href = '/login';
    }, timeoutMinutes * 60 * 1000);
  };
  
  // Eventos que resetean el timeout
  const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
};
```

### 4. **SessionTimeoutAlert.jsx** - Alerta de Expiraci√≥n

**Caracter√≠sticas:**
- Alerta 5 minutos antes de la expiraci√≥n
- Countdown en tiempo real
- Opciones para extender o cerrar sesi√≥n
- Modal overlay con z-index alto

---

## üîÑ Flujo de Autenticaci√≥n

### 1. **Registro de Usuario**

```mermaid
graph TD
    A[Usuario llena formulario] --> B[POST /api/patients o /api/psychologists]
    B --> C[Usuario creado exitosamente]
    C --> D[Login autom√°tico con credenciales]
    D --> E[Token obtenido y guardado]
    E --> F[Redirecci√≥n al dashboard correcto]
```

### 2. **Login Manual**

```mermaid
graph TD
    A[Usuario ingresa credenciales] --> B[POST /api/auth/login]
    B --> C[Token recibido del backend]
    C --> D[Token guardado en localStorage]
    D --> E[GET /api/users/details]
    E --> F[Usuario cargado en contexto]
    F --> G[Redirecci√≥n seg√∫n userType]
```

### 3. **Verificaci√≥n de Sesi√≥n**

```mermaid
graph TD
    A[App inicia] --> B[¬øToken en localStorage?]
    B -->|S√≠| C[¬øToken v√°lido?]
    B -->|No| D[Redirigir a login]
    C -->|S√≠| E[Cargar usuario]
    C -->|No| F[Limpiar sesi√≥n]
    F --> D
```

---

## üõ°Ô∏è Protecciones de Seguridad

### 1. **Limpieza Autom√°tica de Tokens**

#### Escenarios de Limpieza:
- ‚úÖ **Cierre de ventana/pesta√±a** (`beforeunload`)
- ‚úÖ **P√°gina oculta por 30+ minutos** (`visibilitychange`)
- ‚úÖ **Errores 401/403** (Interceptores de respuesta)
- ‚úÖ **Token expirado** (Verificaci√≥n JWT)
- ‚úÖ **Logout manual** (Funci√≥n logout)

#### Implementaci√≥n:
```javascript
// Event listener para cierre de ventana
window.addEventListener('beforeunload', () => {
  clearSession();
});

// Event listener para visibilidad
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    setTimeout(() => {
      if (document.hidden) {
        clearSession();
      }
    }, 30 * 60 * 1000); // 30 minutos
  }
});
```

### 2. **Verificaci√≥n de Expiraci√≥n JWT**

```javascript
const isTokenExpired = () => {
  const token = localStorage.getItem('empathica_token');
  if (!token) return true;
  
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const currentTime = Math.floor(Date.now() / 1000);
    
    // Margen de seguridad de 5 minutos
    return payload.exp < (currentTime - 300);
  } catch (error) {
    return true; // Si hay error, considerar como expirado
  }
};
```

### 3. **Timeout por Inactividad**

- **Tiempo de inactividad**: 60 minutos
- **Alerta previa**: 5 minutos antes
- **Eventos que resetean**: Mouse, teclado, scroll, touch, click
- **Acci√≥n autom√°tica**: Limpieza de sesi√≥n y redirecci√≥n

### 4. **Mapeo Seguro de Roles**

```javascript
const mapUserRolesToType = (userDetails) => {
  let userType = 'client'; // Por defecto seguro
  
  if (userDetails.roles && userDetails.roles.length > 0) {
    const role = userDetails.roles[0];
    
    if (role === 'PSYCHOLOGIST') {
      userType = 'psychologist';
    } else if (role === 'ADMIN') {
      userType = 'business';
    } else if (role === 'PATIENT') {
      userType = 'client';
    }
  }
  
  return {
    ...userDetails,
    userType: userType,
    id: userDetails.userId || userDetails.id
  };
};
```

---

## ‚ö†Ô∏è Manejo de Errores

### 1. **Errores de Autenticaci√≥n**

| C√≥digo | Descripci√≥n | Acci√≥n |
|--------|-------------|--------|
| 401 | Token expirado o inv√°lido | Limpiar sesi√≥n, redirigir a login |
| 403 | Acceso denegado | Limpiar sesi√≥n, redirigir a login |
| 500 | Error del servidor | Mostrar mensaje de error |

### 2. **Errores de Red**

```javascript
// Interceptor de respuesta
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      console.log('Token expirado o inv√°lido, limpiando sesi√≥n...');
      clearSession();
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

### 3. **Errores de Token**

- **Token malformado**: Se considera expirado
- **Token no encontrado**: Redirecci√≥n a login
- **Error de decodificaci√≥n**: Limpieza autom√°tica

---

## ‚öôÔ∏è Configuraci√≥n

### 1. **Timeouts Configurables**

```javascript
// En los dashboards
useSessionTimeout(60); // 60 minutos de inactividad

// En SessionTimeoutAlert
<SessionTimeoutAlert 
  warningMinutes={5}    // Alerta 5 minutos antes
  timeoutMinutes={60}   // Timeout total de 60 minutos
/>
```

### 2. **Event Listeners**

```javascript
// Eventos que resetean el timeout
const events = [
  'mousedown',
  'mousemove', 
  'keypress',
  'scroll',
  'touchstart',
  'click'
];
```

### 3. **Margen de Seguridad**

```javascript
// 5 minutos de margen para expiraci√≥n de token
return payload.exp < (currentTime - 300);
```

---

## üîß Troubleshooting

### 1. **Problema: Sesiones Mezcladas**

**S√≠ntomas:**
- Usuario ve datos de otro usuario
- Token incorrecto en localStorage
- Redirecciones incorrectas

**Soluci√≥n:**
```javascript
// Verificar limpieza en registro
const login = async (credentials) => {
  clearSession(); // Limpiar antes del login
  // ... resto del c√≥digo
};
```

### 2. **Problema: Token No Se Limpia**

**S√≠ntomas:**
- Token persiste despu√©s del logout
- Errores 401 recurrentes
- Usuario no puede hacer logout

**Soluci√≥n:**
```javascript
// Verificar funci√≥n clearSession
const clearSession = () => {
  localStorage.removeItem('empathica_token');
  localStorage.removeItem('empathica_user');
  setUser(null);
};
```

### 3. **Problema: Timeout No Funciona**

**S√≠ntomas:**
- Sesi√≥n no expira por inactividad
- Alertas no aparecen
- Event listeners no se disparan

**Soluci√≥n:**
```javascript
// Verificar hook useSessionTimeout
useSessionTimeout(60); // Asegurar que est√© importado y usado
```

### 4. **Problema: Interceptores No Responden**

**S√≠ntomas:**
- Peticiones fallan sin limpieza
- Errores 401 sin redirecci√≥n
- Tokens obsoletos persisten

**Soluci√≥n:**
```javascript
// Verificar interceptores en api.js
apiClient.interceptors.request.use((config) => {
  if (isTokenExpired()) {
    clearSession();
    return Promise.reject(new Error('Token expirado'));
  }
  // ... resto del c√≥digo
});
```

---

## üìä M√©tricas y Monitoreo

### 1. **Logs de Seguridad**

```javascript
// Logs implementados
console.log('Token expirado, limpiando sesi√≥n...');
console.log('Sesi√≥n cerrada por inactividad (60 minutos)');
console.log('Usuario deslogueado');
console.log('Sesi√≥n completamente limpiada');
```

### 2. **Eventos Rastreables**

- Login exitoso/fallido
- Logout manual/autom√°tico
- Timeout por inactividad
- Errores de autenticaci√≥n
- Limpieza de sesi√≥n

---

## üöÄ Mejores Pr√°cticas

### 1. **Seguridad**
- ‚úÖ Siempre limpiar sesi√≥n antes de login
- ‚úÖ Verificar expiraci√≥n en cada request
- ‚úÖ Usar margen de seguridad para tokens
- ‚úÖ Implementar timeout por inactividad

### 2. **UX**
- ‚úÖ Alertar antes de la expiraci√≥n
- ‚úÖ Permitir extender sesi√≥n
- ‚úÖ Redirecci√≥n autom√°tica a login
- ‚úÖ Mensajes de error claros

### 3. **Mantenimiento**
- ‚úÖ Logs detallados para debugging
- ‚úÖ Configuraci√≥n centralizada
- ‚úÖ Manejo consistente de errores
- ‚úÖ Documentaci√≥n actualizada

---

## üìù Notas de Implementaci√≥n

### Versiones de Dependencias
- React: 18.x
- Axios: Para interceptores HTTP
- localStorage: Para persistencia de tokens

### Compatibilidad
- ‚úÖ Navegadores modernos
- ‚úÖ Dispositivos m√≥viles
- ‚úÖ PWA (Progressive Web App)

### Consideraciones de Rendimiento
- Event listeners con cleanup apropiado
- Timeouts con clearTimeout
- Verificaci√≥n de token optimizada

---

*√öltima actualizaci√≥n: Diciembre 2024*
*Versi√≥n del documento: 1.0*
